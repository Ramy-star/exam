/**
 * @fileoverview Firestore Security Rules for GitGrind application.
 *
 * Core Philosophy:
 * This ruleset prioritizes user data protection and enforces a strict owner-only access model for user-specific data. It allows public read access to lectures, MCQs, and written questions, but restricts write access.
 * Exam results are publicly readable, but creating them requires a valid user ID and lecture ID.
 *
 * Data Structure:
 * - /users/{userId}: Stores private user profiles and preferences.
 * - /lectures/{lectureId}: Stores lecture content.
 * - /mcqs/{mcqId}: Stores multiple-choice questions.
 * - /writtenQuestions/{writtenQuestionId}: Stores written questions.
 * - /examResults/{resultId}: Stores exam results.
 *
 * Key Security Decisions:
 * - Users can only read and write their own profile data.
 * - Listing of users is disallowed.
 * - Lectures, MCQs, and written questions are publicly readable but not writable by clients.
 * - Exam results are publicly readable, but write-protected via checks on the `userId` and `lectureId`.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Secure user profiles. Only the owner can read or write their own profile.
     * @path /users/{userId}
     * @allow (create, update, get, list) if the user's ID matches the document ID.
     * @deny (create, update, get, list) if the user's ID does not match the document ID.
     * @principle Enforces document ownership for all operations.
     */
    match /users/{userId} {
      function isOwner(userId) {
        return request.auth != null && request.auth.uid == userId;
      }

      allow get: if isOwner(userId);
      allow list: if false;
      allow create: if isOwner(userId);
      allow update: if isOwner(userId);
      allow delete: if isOwner(userId);
    }

    /**
     * @description Allows public read access to lectures.  Write access is denied to clients.
     * @path /lectures/{lectureId}
     * @allow (get, list) to everyone.
     * @deny (create, update, delete) to everyone.
     * @principle Allows public read access to lectures
     */
    match /lectures/{lectureId} {
      allow get, list: if true;
      allow create, update, delete: if false;
    }

    /**
     * @description Allows public read access to MCQs.  Write access is denied to clients.
     * @path /mcqs/{mcqId}
     * @allow (get, list) to everyone.
     * @deny (create, update, delete) to everyone.
     * @principle Allows public read access to mcqs
     */
    match /mcqs/{mcqId} {
      allow get, list: if true;
      allow create, update, delete: if false;
    }

    /**
     * @description Allows public read access to written questions.  Write access is denied to clients.
     * @path /writtenQuestions/{writtenQuestionId}
     * @allow (get, list) to everyone.
     * @deny (create, update, delete) to everyone.
     * @principle Allows public read access to writtenQuestions
     */
    match /writtenQuestions/{writtenQuestionId} {
      allow get, list: if true;
      allow create, update, delete: if false;
    }

    /**
     * @description Allows public read access to exam results, but restricts write access.
     * @path /examResults/{resultId}
     * @allow (get, list) to everyone.
     * @deny (update, delete) to everyone.
     * @allow (create) only if the request contains the correct user and lecture IDs.
     * @principle Allows public read access, but restricts writes based on user and lecture.
     */
    match /examResults/{resultId} {
      function isValidExamResultCreate() {
        return request.auth.uid == request.resource.data.userId;
      }

      allow get, list: if true;
      allow create: if isValidExamResultCreate();
      allow update: if false;
      allow delete: if false;
    }
  }
}